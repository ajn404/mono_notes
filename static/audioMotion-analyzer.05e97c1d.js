/**!
 * audioMotion-analyzer
 * High-resolution real-time graphic audio spectrum analyzer JS module
 *
 * @version 4.3.0
 * @author  Henrique Avila Vianna <hvianna@gmail.com> <https://henriquevianna.com>
 * @license AGPL-3.0-or-later
 */const Nt="4.3.0",at=Math.PI,Ne=2*at,Ze=at/2,ht=8.17579892,ct="dual-combined",Pe="dual-horizontal",Le="single",Re="dual-vertical",dt="bar-index",ft="bar-level",Xe="gradient",_t=60,ut="click",Dt="fullscreenchange",xt="resize",Ft="#111",gt="",pt="A",mt="B",Lt="C",Rt="D",wt="468",We="sans-serif",Mt="#0f0",Gt="#7f7f7f22",De=10,kt="create",At="fschange",zt="lores",Ht=xt,et="user",qt="#000c",Et="#fff",Pt="#4f4",St="#888",Xt="#555",tt="bark",ke="linear",Fe="log",it="mel",yt=["#a35","#c66","#e94","#ed0","#9d5","#4d8","#2cb","#0bc","#09c","#36b"],bt=[["classic",{colorStops:["red",{color:"yellow",level:.85,pos:.6},{color:"lime",level:.475}]}],["prism",{colorStops:yt}],["rainbow",{dir:"h",colorStops:["#817",...yt,"#639"]}],["orangered",{bgColor:"#3e2f29",colorStops:["OrangeRed"]}],["steelblue",{bgColor:"#222c35",colorStops:["SteelBlue"]}]],Wt=["ERR_AUDIO_CONTEXT_FAIL","Could not create audio context. Web Audio API not supported?"],Ut=["ERR_INVALID_AUDIO_CONTEXT","Provided audio context is not valid"],Vt=["ERR_UNKNOWN_GRADIENT","Unknown gradient"],st=["ERR_FREQUENCY_TOO_LOW","Frequency values must be >= 1"],Yt=["ERR_INVALID_MODE","Invalid mode"],$t=["ERR_REFLEX_OUT_OF_RANGE","Reflex ratio must be >= 0 and < 1"],jt=["ERR_INVALID_AUDIO_SOURCE","Audio source must be an instance of HTMLMediaElement or AudioNode"],Qt=["ERR_GRADIENT_INVALID_NAME","Gradient name must be a non-empty string"],Kt=["ERR_GRADIENT_NOT_AN_OBJECT","Gradient options must be an object"],Jt=["ERR_GRADIENT_MISSING_COLOR","Gradient colorStops must be a non-empty array"];class he extends Error{constructor(e,i){const[s,o]=e;super(o+(i!==void 0?`: ${i}`:"")),this.name="AudioMotionError",this.code=s}}const Ct=(fe,e)=>console.warn(`${fe} is deprecated. Use ${e} instead.`),Ue=(fe,e,i="toLowerCase")=>e[Math.max(0,e.indexOf((""+fe)[i]()))],Zt=(fe,e,i,s,o)=>e+(s-e)*(o-fe)/(i-fe);Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(fe){let e=this.length;for(;e-- >0;)if(fe(this[e]))return e;return-1});class ti{constructor(e,i={}){this._ready=!1,this._aux={},this._canvasGradients=[],this._destroyed=!1,this._energy={val:0,peak:0,hold:0},this._flg={},this._fps=0,this._gradients={},this._last=0,this._outNodes=[],this._ownContext=!1,this._selectedGrads=[],this._sources=[];for(const[u,y]of bt)this.registerGradient(u,y);this._container=e||document.body,this._defaultWidth=this._container.clientWidth||640,this._defaultHeight=this._container.clientHeight||270;let s;if(!(i.source&&(s=i.source.context))){if(!(s=i.audioCtx))try{s=new(window.AudioContext||window.webkitAudioContext),this._ownContext=!0}catch{throw new he(Wt)}}if(!s.createGain)throw new he(Ut);const o=this._analyzer=[s.createAnalyser(),s.createAnalyser()],d=this._splitter=s.createChannelSplitter(2),r=this._merger=s.createChannelMerger(2);this._input=s.createGain(),this._output=s.createGain(),i.source&&this.connectInput(i.source);for(const u of[0,1])d.connect(o[u],u);r.connect(this._output),i.connectSpeakers!==!1&&this.connectOutput();const a=document.createElement("canvas");a.style="max-width: 100%;",this._ctx=a.getContext("2d");for(const u of["_scaleX","_scaleR"])this[u]=document.createElement("canvas").getContext("2d");this._fsEl=i.fsElement||a;const h=()=>{this._fsTimeout||(this._fsTimeout=window.setTimeout(()=>{this._fsChanging||(this._setCanvas(Ht),this._fsTimeout=0)},_t))};window.ResizeObserver&&(this._observer=new ResizeObserver(h),this._observer.observe(this._container)),this._controller=new AbortController;const x=this._controller.signal;window.addEventListener(xt,h,{signal:x}),a.addEventListener(Dt,()=>{this._fsChanging=!0,this._fsTimeout&&window.clearTimeout(this._fsTimeout),this._setCanvas(At),this._fsTimeout=window.setTimeout(()=>{this._fsChanging=!1,this._fsTimeout=0},_t)},{signal:x});const R=()=>{s.state=="suspended"&&s.resume(),window.removeEventListener(ut,R)};window.addEventListener(ut,R),document.addEventListener("visibilitychange",()=>{document.visibilityState!="hidden"&&(this._frames=0,this._time=performance.now())},{signal:x}),this._setProps(i,!0),this.useCanvas&&this._container.appendChild(a),this._ready=!0,this._setCanvas(kt)}get alphaBars(){return this._alphaBars}set alphaBars(e){this._alphaBars=!!e,this._calcBars()}get ansiBands(){return this._ansiBands}set ansiBands(e){this._ansiBands=!!e,this._calcBars()}get barSpace(){return this._barSpace}set barSpace(e){this._barSpace=+e||0,this._calcBars()}get channelLayout(){return this._chLayout}set channelLayout(e){this._chLayout=Ue(e,[Le,Pe,Re,ct]),this._input.disconnect(),this._input.connect(this._chLayout!=Le?this._splitter:this._analyzer[0]),this._analyzer[0].disconnect(),this._outNodes.length&&this._analyzer[0].connect(this._chLayout!=Le?this._merger:this._output),this._calcBars(),this._makeGrad()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=Ue(e,[Xe,dt,ft])}get fftSize(){return this._analyzer[0].fftSize}set fftSize(e){for(const s of[0,1])this._analyzer[s].fftSize=e;const i=this._analyzer[0].frequencyBinCount;this._fftData=[new Float32Array(i),new Float32Array(i)],this._calcBars()}get frequencyScale(){return this._frequencyScale}set frequencyScale(e){this._frequencyScale=Ue(e,[Fe,tt,it,ke]),this._calcBars()}get gradient(){return this._selectedGrads[0]}set gradient(e){this._setGradient(e)}get gradientLeft(){return this._selectedGrads[0]}set gradientLeft(e){this._setGradient(e,0)}get gradientRight(){return this._selectedGrads[1]}set gradientRight(e){this._setGradient(e,1)}get height(){return this._height}set height(e){this._height=e,this._setCanvas(et)}get ledBars(){return this._showLeds}set ledBars(e){this._showLeds=!!e,this._calcBars()}get linearAmplitude(){return this._linearAmplitude}set linearAmplitude(e){this._linearAmplitude=!!e}get linearBoost(){return this._linearBoost}set linearBoost(e){this._linearBoost=e>=1?+e:1}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=+e||0}get loRes(){return this._loRes}set loRes(e){this._loRes=!!e,this._setCanvas(zt)}get lumiBars(){return this._lumiBars}set lumiBars(e){this._lumiBars=!!e,this._calcBars(),this._makeGrad()}get maxDecibels(){return this._analyzer[0].maxDecibels}set maxDecibels(e){for(const i of[0,1])this._analyzer[i].maxDecibels=e}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e<0?0:+e||0}get maxFreq(){return this._maxFreq}set maxFreq(e){if(e<1)throw new he(st);this._maxFreq=Math.min(e,this.audioCtx.sampleRate/2),this._calcBars()}get minDecibels(){return this._analyzer[0].minDecibels}set minDecibels(e){for(const i of[0,1])this._analyzer[i].minDecibels=e}get minFreq(){return this._minFreq}set minFreq(e){if(e<1)throw new he(st);this._minFreq=+e,this._calcBars()}get mirror(){return this._mirror}set mirror(e){this._mirror=Math.sign(e)|0,this._calcBars(),this._makeGrad()}get mode(){return this._mode}set mode(e){const i=e|0;if(i>=0&&i<=10&&i!=9)this._mode=i,this._calcBars(),this._makeGrad();else throw new he(Yt,e)}get noteLabels(){return this._noteLabels}set noteLabels(e){this._noteLabels=!!e,this._createScales()}get outlineBars(){return this._outlineBars}set outlineBars(e){this._outlineBars=!!e,this._calcBars()}get peakLine(){return this._peakLine}set peakLine(e){this._peakLine=!!e}get radial(){return this._radial}set radial(e){this._radial=!!e,this._calcBars(),this._makeGrad()}get reflexRatio(){return this._reflexRatio}set reflexRatio(e){if(e=+e||0,e<0||e>=1)throw new he($t);this._reflexRatio=e,this._calcBars(),this._makeGrad()}get roundBars(){return this._roundBars}set roundBars(e){this._roundBars=!!e,this._calcBars()}get smoothing(){return this._analyzer[0].smoothingTimeConstant}set smoothing(e){for(const i of[0,1])this._analyzer[i].smoothingTimeConstant=e}get spinSpeed(){return this._spinSpeed}set spinSpeed(e){e=+e||0,(this._spinSpeed===void 0||e==0)&&(this._spinAngle=-Ze),this._spinSpeed=e}get splitGradient(){return this._splitGradient}set splitGradient(e){this._splitGradient=!!e,this._makeGrad()}get stereo(){return Ct("stereo","channelLayout"),this._chLayout!=Le}set stereo(e){Ct("stereo","channelLayout"),this.channelLayout=e?Re:Le}get trueLeds(){return this._trueLeds}set trueLeds(e){this._trueLeds=!!e}get volume(){return this._output.gain.value}set volume(e){this._output.gain.value=e}get weightingFilter(){return this._weightingFilter}set weightingFilter(e){this._weightingFilter=Ue(e,[gt,pt,mt,Lt,Rt,wt],"toUpperCase")}get width(){return this._width}set width(e){this._width=e,this._setCanvas(et)}get audioCtx(){return this._input.context}get canvas(){return this._ctx.canvas}get canvasCtx(){return this._ctx}get connectedSources(){return this._sources}get connectedTo(){return this._outNodes}get fps(){return this._fps}get fsHeight(){return this._fsHeight}get fsWidth(){return this._fsWidth}get isAlphaBars(){return this._flg.isAlpha}get isBandsMode(){return this._flg.isBands}get isDestroyed(){return this._destroyed}get isFullscreen(){return this._fsEl&&(document.fullscreenElement||document.webkitFullscreenElement)===this._fsEl}get isLedBars(){return this._flg.isLeds}get isLumiBars(){return this._flg.isLumi}get isOctaveBands(){return this._flg.isOctaves}get isOn(){return!!this._runId}get isOutlineBars(){return this._flg.isOutline}get pixelRatio(){return this._pixelRatio}get isRoundBars(){return this._flg.isRound}static get version(){return Nt}connectInput(e){const i=e instanceof HTMLMediaElement;if(!(i||e.connect))throw new he(jt);const s=i?this.audioCtx.createMediaElementSource(e):e;return this._sources.includes(s)||(s.connect(this._input),this._sources.push(s)),s}connectOutput(e=this.audioCtx.destination){if(!this._outNodes.includes(e)&&(this._output.connect(e),this._outNodes.push(e),this._outNodes.length==1))for(const i of[0,1])this._analyzer[i].connect(this._chLayout==Le&&!i?this._output:this._merger,0,i)}destroy(){if(!this._ready)return;const{audioCtx:e,canvas:i,_controller:s,_input:o,_merger:d,_observer:r,_ownContext:a,_splitter:h}=this;this._destroyed=!0,this._ready=!1,this.stop(),s.abort(),r&&r.disconnect(),this.onCanvasResize=null,this.onCanvasDraw=null,this._fsEl=null,this.disconnectInput(),this.disconnectOutput(),o.disconnect(),h.disconnect(),d.disconnect(),a&&e.close(),i.remove(),this._calcBars()}disconnectInput(e,i){e?Array.isArray(e)||(e=[e]):e=Array.from(this._sources);for(const s of e){const o=this._sources.indexOf(s);if(i&&s.mediaStream)for(const d of s.mediaStream.getAudioTracks())d.stop();o>=0&&(s.disconnect(this._input),this._sources.splice(o,1))}}disconnectOutput(e){if(!(e&&!this._outNodes.includes(e))&&(this._output.disconnect(e),this._outNodes=e?this._outNodes.filter(i=>i!==e):[],this._outNodes.length==0))for(const i of[0,1])this._analyzer[i].disconnect()}getBars(){return Array.from(this._bars,({posX:e,freq:i,freqLo:s,freqHi:o,hold:d,peak:r,value:a})=>({posX:e,freq:i,freqLo:s,freqHi:o,hold:d,peak:r,value:a}))}getEnergy(e,i){if(e===void 0)return this._energy.val;if(e!=+e){if(e=="peak")return this._energy.peak;const a={bass:[20,250],lowMid:[250,500],mid:[500,2e3],highMid:[2e3,4e3],treble:[4e3,16e3]};if(!a[e])return null;[e,i]=a[e]}const s=this._freqToBin(e),o=i?this._freqToBin(i):s,d=this._chLayout==Le?1:2;let r=0;for(let a=0;a<d;a++)for(let h=s;h<=o;h++)r+=this._normalizedB(this._fftData[a][h]);return r/(o-s+1)/d}registerGradient(e,i){if(typeof e!="string"||e.trim().length==0)throw new he(Qt);if(typeof i!="object")throw new he(Kt);const{colorStops:s}=i;if(!Array.isArray(s)||!s.length)throw new he(Jt);const o=s.length,d=r=>+r!=r||r<0||r>1;s.forEach((r,a)=>{const h=a/Math.max(1,o-1);typeof r!="object"?s[a]={pos:h,color:r}:d(r.pos)&&(r.pos=h),d(r.level)&&(s[a].level=1-a/o)}),s.sort((r,a)=>r.level<a.level?1:r.level>a.level?-1:0),s[0].level=1,this._gradients[e]={bgColor:i.bgColor||Ft,dir:i.dir,colorStops:s},this._selectedGrads.includes(e)&&this._makeGrad()}setCanvasSize(e,i){this._width=e,this._height=i,this._setCanvas(et)}setFreqRange(e,i){if(e<1||i<1)throw new he(st);this._minFreq=Math.min(e,i),this.maxFreq=Math.max(e,i)}setLedParams(e){let i,s,o;e&&(i=e.maxLeds|0,s=+e.spaceV,o=+e.spaceH),this._ledParams=i>0&&s>0&&o>=0?[i,s,o]:void 0,this._calcBars()}setOptions(e){this._setProps(e)}setSensitivity(e,i){for(const s of[0,1])this._analyzer[s].minDecibels=Math.min(e,i),this._analyzer[s].maxDecibels=Math.max(e,i)}start(){this.toggleAnalyzer(!0)}stop(){this.toggleAnalyzer(!1)}toggleAnalyzer(e){const i=this.isOn;return e===void 0&&(e=!i),i&&!e?(cancelAnimationFrame(this._runId),this._runId=0):!i&&e&&!this._destroyed&&(this._frames=0,this._time=performance.now(),this._runId=requestAnimationFrame(s=>this._draw(s))),this.isOn}toggleFullscreen(){if(this.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{const e=this._fsEl;if(!e)return;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}}_binToFreq(e){return e*this.audioCtx.sampleRate/this.fftSize||1}_calcBars(){const e=this._bars=[];if(!this._ready){this._flg={isAlpha:!1,isBands:!1,isLeds:!1,isLumi:!1,isOctaves:!1,isOutline:!1,isRound:!1,noLedGap:!1};return}const{_ansiBands:i,_barSpace:s,canvas:o,_chLayout:d,_maxFreq:r,_minFreq:a,_mirror:h,_mode:x,_radial:R,_reflexRatio:u}=this,y=o.width>>1,z=o.height>>1,V=d==Re&&!R,Y=d==Pe,I=x%10!=0,Q=I&&this._frequencyScale==Fe,X=this._showLeds&&I&&!R,w=this._lumiBars&&I&&!R,Z=this._alphaBars&&!w&&x!=De,_e=this._outlineBars&&I&&!w&&!X,K=this._roundBars&&I&&!w&&!X,g=d!=Re||u>0&&!w,ee=o.height-(V&&!X?.5:0)>>V,N=ee*(w||R?1:1-u)|0,J=o.width-y*(Y||h!=0),t=V?o.height-ee*2:0,U=y*(h==-1&&!Y&&!R),we=Math.min(o.width,o.height)*(d==Re?.375:.125)|0,H=Math.min(y,z),T=C=>e.push({...C,peak:[0,0],hold:[0],value:[0]}),b=C=>{const v=this._freqToBin(C,"floor"),p=this._binToFreq(v),A=this._binToFreq(v+1),F=Math.log2(C/p)/Math.log2(A/p);return[v,F]};let f,M,B;if(Q){const C=(S,G,ne)=>+S.toPrecision(ne?Math.max(G,1+Math.log10(S)|0):G),v=S=>{const G=[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9,10],ne=Math.log10(S)|0,se=S/10**ne;let re=1;for(;re<G.length&&se>G[re];)re++;return se-G[re-1]<G[re]-se&&re--,(G[re]*10**(ne+5)|0)/1e5},p=[0,24,12,8,6,4,3,2,1][x],A=i?10**(3/(p*10)):2**(1/p),F=A**.5;let q=i?7.94328235/(p%2?1:F):ht;do{let S=q;const G=C(S/F,4,!0),ne=C(S*F,4,!0),[se,re]=b(G),[ve,pe]=b(ne);i?S=p<4?v(S):C(S,S.toString()[0]<5?3:2):S=C(S,4,!0),S>=a&&T({posX:0,freq:S,freqLo:G,freqHi:ne,binLo:se,binHi:ve,ratioLo:re,ratioHi:pe}),q*=A}while(q<=r);f=J/e.length,e.forEach((S,G)=>S.posX=U+G*f);const O=e[0],m=e[e.length-1];M=this._freqScaling(O.freqLo),B=J/(this._freqScaling(m.freqHi)-M),O.freqLo<a&&(O.freqLo=a,[O.binLo,O.ratioLo]=b(a)),m.freqHi>r&&(m.freqHi=r,[m.binHi,m.ratioHi]=b(r))}else if(I){const C=[0,24,12,8,6,4,3,2,1][x]*10,v=p=>{switch(this._frequencyScale){case tt:return 1960/(26.81/(p+.53)-1);case it:return 700*(2**p-1);case ke:return p}};f=J/C,M=this._freqScaling(a),B=J/(this._freqScaling(r)-M);for(let p=0,A=0;p<C;p++,A+=f){const F=v(M+A/B),q=v(M+(A+f/2)/B),O=v(M+(A+f)/B),[m,S]=b(F),[G,ne]=b(O);T({posX:U+A,freq:q,freqLo:F,freqHi:O,binLo:m,binHi:G,ratioLo:S,ratioHi:ne})}}else{f=1,M=this._freqScaling(a),B=J/(this._freqScaling(r)-M);const C=this._freqToBin(a,"floor"),v=this._freqToBin(r);let p=-999;for(let A=C;A<=v;A++){const F=this._binToFreq(A),q=U+Math.round(B*(this._freqScaling(F)-M));if(q>p)T({posX:q,freq:F,freqLo:F,freqHi:F,binLo:A,binHi:A,ratioLo:0,ratioHi:0}),p=q;else if(e.length){const O=e[e.length-1];O.binHi=A,O.freqHi=F,O.freq=(O.freqLo*F)**.5}}}let ie=0,W=0;if(X){const C=this._pixelRatio/(window.devicePixelRatio>1&&window.screen.height<=540?2:1),v=[[],[128,3,.45],[128,4,.225],[96,6,.225],[80,6,.225],[80,6,.125],[64,6,.125],[48,8,.125],[24,16,.125]],p=this._ledParams,[A,F,q]=p||v[x];let O,m=N;if(p){const S=2*C;let G;O=A+1;do O--,G=m/O/(1+F),W=G*F;while((G<S||W<S)&&O>1)}else{const S=540/F;W=Math.min(F*C,Math.max(2,m/S+.1|0))}g&&(m+=W),p||(O=Math.min(A,m/(W*2)|0)),ie=q>=1?q:f*q,this._leds=[O,ie,W,m/O-W]}const E=Math.min(f-1,s*(s>0&&s<1?f:1));I&&(f-=Math.max(X?ie:0,E)),e.forEach((C,v)=>{let p=C.posX,A=f;I&&(s==0&&!X?(p|=0,A|=0,v>0&&p>e[v-1].posX+e[v-1].width&&(p--,A++)):p+=Math.max(X?ie:0,E)/2,C.posX=p),C.barCenter=p+(f==1?0:A/2),C.width=A});const ce=[];for(const C of[0,1]){const v=d==Re?(ee+t)*C:0,p=v+ee,A=v+N-(!X||g?0:W);ce.push({channelTop:v,channelBottom:p,analyzerBottom:A})}this._aux={analyzerHeight:N,analyzerWidth:J,centerX:y,centerY:z,channelCoords:ce,channelHeight:ee,channelGap:t,initialX:U,innerRadius:we,outerRadius:H,scaleMin:M,unitWidth:B},this._flg={isAlpha:Z,isBands:I,isLeds:X,isLumi:w,isOctaves:Q,isOutline:_e,isRound:K,noLedGap:g},this._createScales()}_createScales(){if(!this._ready)return;const{analyzerWidth:e,initialX:i,innerRadius:s,scaleMin:o,unitWidth:d}=this._aux,{canvas:r,_frequencyScale:a,_mirror:h,_noteLabels:x,_radial:R,_scaleX:u,_scaleR:y}=this,z=u.canvas,V=y.canvas,Y=[],I=this._chLayout==Pe,Q=this._chLayout==Re,X=["C",,"D",,"E","F",,"G",,"A",,"B"],w=Math.min(r.width,r.height)/34|0,Z=z.height>>1,_e=w>>1,K=Z*(x?.7:1.5),g=_e*(x?1:2),ee=2**(1/12);if(!x&&(this._ansiBands||a!=Fe))Y.push(16,31.5,63,125,250,500,1e3,2e3,4e3),a==ke?Y.push(6e3,8e3,1e4,12e3,14e3,16e3,18e3,2e4,22e3):Y.push(8e3,16e3);else{let H=ht;for(let T=-1;T<11;T++)for(let b=0;b<12;b++){if(H>=this._minFreq&&H<=this._maxFreq){const f=X[b],M=f=="C";(f&&x&&!h&&!I||M)&&Y.push(x?[H,f+(M?T:"")]:H)}H*=ee}}V.width=V.height=(s<<1)+Q*w;const N=V.width>>1,J=N-w*.7,t=(H,T)=>{const b=Ne*(H/r.width),f=b-Ze,M=J*Math.cos(f),B=J*Math.sin(f);y.save(),y.translate(N+M,N+B),y.rotate(b),y.fillText(T,0,0),y.restore()};z.width|=0,u.fillStyle=y.strokeStyle=qt,u.fillRect(0,0,z.width,z.height),y.arc(N,N,N-w/2,0,Ne),y.lineWidth=w,y.stroke(),u.fillStyle=y.fillStyle=Et,u.font=`${Z}px ${We}`,y.font=`${_e}px ${We}`,u.textAlign=y.textAlign="center";let U=-K/4,we=-g;for(const H of Y){const[T,b]=Array.isArray(H)?H:[H,H<1e3?H|0:`${(H/100|0)/10}k`],f=d*(this._freqScaling(T)-o),M=z.height*.75,B=b[0]=="C",ie=Z*(x&&!h&&!I?B?1.2:.6:3);if(u.fillStyle=y.fillStyle=B&&!h&&!I?Pt:Et,x){const W=a==Fe,E=a==ke;let ce=["C"];if((W||T>2e3||!E&&T>250||(!R||Q)&&(!E&&T>125||T>1e3))&&ce.push("G"),(W||T>4e3||!E&&T>500||(!R||Q)&&(!E&&T>250||T>2e3))&&ce.push("E"),(E&&T>4e3||(!R||Q)&&(W||T>2e3||!E&&T>500))&&ce.push("D","F","A","B"),!ce.includes(b[0]))continue}f>=U+K/2&&f<=e&&(u.fillText(b,I&&h==-1?e-f:i+f,M,ie),(I||h&&(f>K||h==1))&&u.fillText(b,I&&h!=1?e+f:(i||r.width)-f,M,ie),U=f+Math.min(ie,u.measureText(b).width)/2),f>=we+g&&f<e-g&&(t(I&&h==1?e-f:f,b),(I||h&&(f>g||h==1))&&t(I&&h!=-1?e+f:-f,b),we=f)}}_draw(e){this._runId=requestAnimationFrame(n=>this._draw(n));const i=e-this._time,s=e-this._last,o=this._maxFPS?975/this._maxFPS:0;if(s<o)return;this._last=e-(o?s%o:0),this._frames++,i>=1e3&&(this._fps=this._frames/i*1e3,this._frames=0,this._time=e);const{isAlpha:d,isBands:r,isLeds:a,isLumi:h,isOctaves:x,isOutline:R,isRound:u,noLedGap:y}=this._flg,{analyzerHeight:z,centerX:V,centerY:Y,channelCoords:I,channelHeight:Q,channelGap:X,initialX:w,innerRadius:Z,outerRadius:_e}=this._aux,{_bars:K,canvas:g,_canvasGradients:ee,_chLayout:N,_colorMode:J,_ctx:t,_energy:U,fillAlpha:we,_fps:H,_linearAmplitude:T,_lineWidth:b,maxDecibels:f,minDecibels:M,_mirror:B,_mode:ie,overlay:W,_radial:E,showBgColor:ce,showPeaks:C,useCanvas:v,_weightingFilter:p}=this,A=this._scaleX.canvas,F=this._scaleR.canvas,q=H>>1,O=N==ct,m=N==Pe,S=N==Re,G=N==Le,ne=a&&this._trueLeds&&J==Xe,se=E?g.width:this._aux.analyzerWidth,re=w+se,ve=C&&this._peakLine&&ie==De,pe=E?_e-Z:z,[Bt,ei,Me,Ve]=this._leds||[];U.val>0&&(this._spinAngle+=this._spinSpeed*Ne/(60*H));const Tt=n=>{if(this._reflexRatio>0&&!h&&!E){let L,ue;this.reflexFit||S?(L=S&&n==0?Q+X:0,ue=Q-z):(L=g.height-z*2,ue=z),t.save(),t.globalAlpha=this.reflexAlpha,this.reflexBright!=1&&(t.filter=`brightness(${this.reflexBright})`),t.setTransform(1,0,0,-1,0,g.height),t.drawImage(g,0,I[n].channelTop,g.width,z,0,L,g.width,ue),t.restore()}},vt=()=>{this.showScaleX&&(E?(t.save(),t.translate(V,Y),this._spinSpeed&&t.rotate(this._spinAngle+Ze),t.drawImage(F,-F.width>>1,-F.width>>1),t.restore()):t.drawImage(A,0,g.height-A.height))},Ot=n=>{const L=n**2,ue=424.36,$=11599.29,ze=25122.25,Ae=544496.41,me=148693636,be=Ce=>20*Math.log10(Ce);switch(p){case pt:const Ce=me*L**2/((L+ue)*Math.sqrt((L+$)*(L+Ae))*(L+me));return 2+be(Ce);case mt:const xe=me*L*n/((L+ue)*Math.sqrt(L+ze)*(L+me));return .17+be(xe);case Lt:const je=me*L/((L+ue)*(L+me));return .06+be(je);case Rt:const He=((103791848e-2-L)**2+108076816e-2*L)/((9837328-L)**2+11723776*L),Qe=n/68966888496476e-18*Math.sqrt(He/((L+79919.29)*(L+1345600)));return be(Qe);case wt:const qe=-4737338981378384e-39*n**6+2043828333606125e-30*n**4-1363894795463638e-22*L+1,Be=1306612257412824e-34*n**5-2118150887518656e-26*n**3+.0005559488023498642*n,oe=.0001246332637532143*n/Math.hypot(qe,Be);return 18.2+be(oe)}return 0},Ye=(n,L,ue)=>{t.beginPath(),t.moveTo(n,L),t.lineTo(n,ue),t.stroke()},$e=n=>{if(n&&b){const L=t.globalAlpha;t.globalAlpha=1,t.stroke(),t.globalAlpha=L}},ye=n=>Math.max(0,(n*Bt|0)*(Ve+Me)-Me),It=n=>{U.val=n,U.peak>0&&(U.hold--,U.hold<0&&(U.peak+=U.hold/(q*q/2))),n>=U.peak&&(U.peak=n,U.hold=q)};W&&t.clearRect(0,0,g.width,g.height);let nt=0;const rt=K.length,ot=G?1:2;for(let n=0;n<ot;n++){const{channelTop:L,channelBottom:ue,analyzerBottom:$}=I[n],ze=this._gradients[this._selectedGrads[n]],Ae=ze.colorStops,me=Ae.length,be=!ce||a&&!W?"#000":ze.bgColor,Ce=S&&E&&n?-1:1,xe=!n&&B==-1||n&&B==1,je=!m||n&&B!=1?0:se>>(n||!xe),He=m&&xe?-1:1,Qe=()=>{const l=A.height,_=l>>1,c=T?100:f,D=T?0:M,P=T?20:5,ae=z/(c-D),ge=B!=-1&&(!m||n==0||B==1),Ee=B!=1&&(!m||n!=B);t.save(),t.fillStyle=St,t.font=`${_}px ${We}`,t.textAlign="right",t.lineWidth=1;for(let Se=c;Se>D;Se-=P){const Oe=L+(c-Se)*ae,j=Se%2==0|0;if(j){const te=Oe+_*(Oe==L?.8:.35);ge&&t.fillText(Se,l*.85,te),Ee&&t.fillText(Se,(m?se:g.width)-l*.1,te),t.strokeStyle=St,t.setLineDash([2,4]),t.lineDashOffset=0}else t.strokeStyle=Xt,t.setLineDash([2,8]),t.lineDashOffset=1;t.beginPath(),t.moveTo(w+l*j*ge,~~Oe+.5),t.lineTo(re-l*j*Ee,~~Oe+.5),t.stroke()}t.restore()},qe=(l,_)=>{const c=de[l]+(l<de.length-1?(de[l+1]-de[l])*_:0);return isNaN(c)?-1/0:c},Be=(l,_=He)=>_*Ne*((l+je)/g.width)+this._spinAngle,oe=(l,_,c)=>{const D=Z+_*Ce,P=Be(l,c);return[V+D*Math.cos(P),Y+D*Math.sin(P)]},Ke=(l,_,c,D,P)=>{t.beginPath();for(const ae of B&&!m?[1,-1]:[He]){const[ge,Ee]=u?[Be(l,ae),Be(l+c,ae)]:[];t.moveTo(...oe(l,_,ae)),t.lineTo(...oe(l,_+D,ae)),u?t.arc(V,Y,Z+(_+D)*Ce,ge,Ee,ae!=1):t.lineTo(...oe(l+c,_+D,ae)),t.lineTo(...oe(l+c,_,ae)),u&&!P&&t.arc(V,Y,Z+_*Ce,Ee,ge,ae==1)}$e(P),t.fill()},Je=(l=0,_=0)=>{let c;if(J==Xe&&!ne||ie==De)c=ee[n];else{const D=J==dt?_%me:Ae.findLastIndex(P=>a?ye(l)<=ye(P.level):l<=P.level);c=Ae[D].color}t.fillStyle=t.strokeStyle=c};if(v){if(m&&!E){const l=se*(n+xe),_=xe?-1:1;t.setTransform(_,0,0,1,l,0)}if((!W||ce)&&(W&&(t.globalAlpha=this.bgAlpha),t.fillStyle=be,(n==0||!E&&!O)&&t.fillRect(w,L-X,se,(W&&this.reflexAlpha==1?z:Q)+X),t.globalAlpha=1),this.showScaleY&&!h&&!E&&(n==0||!O)&&Qe(),a?(t.setLineDash([Ve,Me]),t.lineWidth=K[0].width):t.lineWidth=R?Math.min(b,K[0].width/2):b,t.save(),!E){const l=new Path2D;l.rect(0,L,g.width,z),t.clip(l)}}let de=this._fftData[n];this._analyzer[n].getFloatFrequencyData(de),p&&(de=de.map((l,_)=>l+Ot(this._binToFreq(_)))),t.beginPath();let Ge=[];for(let l=0;l<rt;l++){const _=K[l],{posX:c,barCenter:D,width:P,freq:ae,binLo:ge,binHi:Ee,ratioLo:Se,ratioHi:Oe}=_;let j=Math.max(qe(ge,Se),qe(Ee,Oe));for(let k=ge+1;k<Ee;k++)de[k]>j&&(j=de[k]);if(j=this._normalizedB(j),_.value[n]=j,nt+=j,_.peak[n]>0&&(_.hold[n]--,_.hold[n]<0&&(_.peak[n]+=_.hold[n]/(q*q/2))),j>=_.peak[n]&&(_.peak[n]=j,_.hold[n]=q),!v)continue;h||d?t.globalAlpha=j:R&&(t.globalAlpha=we),Je(j,l);const te=h?pe:a?ye(j):j*pe|0;if(ie==De){const k=l?0:(this._normalizedB(de[K[1].binLo])*pe+te)/2;if(E){if(l==0&&(m&&t.moveTo(...oe(0,0)),t.lineTo(...oe(0,c<0?k:te))),c>=0){const le=[c,te];t.lineTo(...oe(...le)),Ge.push(le)}}else{if(l==0)if(B==-1&&!m)t.moveTo(w,$-(c<w?k:te));else{const le=ge?this._normalizedB(de[ge-1])*pe:te;t.moveTo(w-b,$-le)}(m||B!=-1||c>=w)&&t.lineTo(c,$-te)}}else if(a){if(ce&&!W&&(n==0||!O)){const k=t.globalAlpha;t.strokeStyle=Gt,t.globalAlpha=1,Ye(D,L,$),t.strokeStyle=t.fillStyle,t.globalAlpha=k}if(ne){const k=h?0:Ae.findLastIndex(Te=>ye(j)<=ye(Te.level));let le=$;for(let Te=me-1;Te>=k;Te--){t.strokeStyle=Ae[Te].color;let lt=$-(Te==k?te:ye(Ae[Te].level));Ye(D,le,lt),le=lt-Me}}else Ye(D,$,$-te)}else if(c>=w)if(E)Ke(c,0,P,te,R);else if(u){const k=P/2,le=$+k;t.beginPath(),t.moveTo(c,le),t.lineTo(c,le-te),t.arc(D,le-te,k,at,Ne),t.lineTo(c+P,le),$e(R),t.fill()}else{const k=R?t.lineWidth:0;t.beginPath(),t.rect(c,$+k,P,-te-k),$e(R),t.fill()}const Ie=_.peak[n];if(Ie>0&&C&&!ve&&!h&&c>=w&&c<re)if(R&&b>0?t.globalAlpha=1:d&&(t.globalAlpha=Ie),(J==ft||ne)&&Je(Ie),a){const k=ye(Ie);k>=Me&&t.fillRect(c,$-k,P,Ve)}else E?ie!=De&&Ke(c,Ie*pe,P,-2):t.fillRect(c,$-Ie*pe,P,2)}if(v){if(t.globalAlpha=1,ie==De){if(Je(),E&&!m){if(B){let l;for(;l=Ge.pop();)t.lineTo(...oe(...l,-1))}t.closePath()}if(b>0&&t.stroke(),we>0){if(E){const l=m?Be(se>>1):0,_=m?Be(se):Ne;t.moveTo(...oe(m?se>>1:0,0)),t.arc(V,Y,Z,l,_,m?!xe:!0)}else t.lineTo(re,$),t.lineTo(w,$);t.globalAlpha=we,t.fill(),t.globalAlpha=1}if((ve||E&&C)&&(Ge=[],t.beginPath(),K.forEach((l,_)=>{let c=l.posX,D=l.peak[n],P=_?"lineTo":"moveTo";if(E&&c<0){const ae=K[_+1];D=Zt(c,D,ae.posX,ae.peak[n],0),c=0}D*=pe,ve?(t[P](...E?oe(c,D):[c,$-D]),E&&B&&!m&&Ge.push([c,D])):D>0&&Ke(c,D,1,-2)}),ve)){let l;for(;l=Ge.pop();)t.lineTo(...oe(...l,-1));t.lineWidth=1,t.stroke()}}t.restore(),m&&!E&&t.setTransform(1,0,0,1,0,0),(!m&&!O||n)&&Tt(n)}}if(It(nt/(rt<<ot-1)),v&&(B&&!E&&!m&&(t.setTransform(-1,0,0,1,g.width-w,0),t.drawImage(g,w,0,V,g.height,0,0,V,g.height),t.setTransform(1,0,0,1,0,0)),t.setLineDash([]),vt()),this.showFPS){const n=A.height;t.font=`bold ${n}px ${We}`,t.fillStyle=Mt,t.textAlign="right",t.fillText(Math.round(H),g.width-n,n*2)}this.onCanvasDraw&&(t.save(),t.fillStyle=t.strokeStyle=ee[0],this.onCanvasDraw(this,{timestamp:e,_canvasGradients:ee}),t.restore())}_freqScaling(e){switch(this._frequencyScale){case Fe:return Math.log2(e);case tt:return 26.81*e/(1960+e)-.53;case it:return Math.log2(1+e/700);case ke:return e}}_freqToBin(e,i="round"){const s=this._analyzer[0].frequencyBinCount-1,o=Math[i](e*this.fftSize/this.audioCtx.sampleRate);return o<s?o:s}_makeGrad(){if(!this._ready)return;const{canvas:e,_ctx:i,_radial:s,_reflexRatio:o}=this,{analyzerWidth:d,centerX:r,centerY:a,initialX:h,innerRadius:x,outerRadius:R}=this._aux,{isLumi:u}=this._flg,y=this._chLayout==Re,z=1-o,V=u?e.height:e.height*(1-o*!y)|0;for(const Y of[0,1]){const I=this._gradients[this._selectedGrads[Y]],Q=I.colorStops,X=I.dir=="h";let w;if(s?w=i.createRadialGradient(r,a,R,r,a,x-(R-x)*y):w=i.createLinearGradient(...X?[h,0,h+d,0]:[0,0,0,V]),Q){const Z=y&&!this._splitGradient&&(!X||s);for(let _e=0;_e<1+Z;_e++){const K=Q.length-1;Q.forEach((g,ee)=>{let N=g.pos;if(Z&&(N/=2),y&&!u&&!s&&!X&&(N*=z,!Z&&N>.5*z&&(N+=.5*o)),_e==1)if(s||u){const J=K-ee;g=Q[J],N=1-g.pos/2}else ee==0&&N>0&&w.addColorStop(.5,g.color),N+=.5;w.addColorStop(N,g.color),y&&ee==K&&N<.5&&w.addColorStop(.5,g.color)})}}this._canvasGradients[Y]=w}}_normalizedB(e){const i=this._linearAmplitude,s=i?1/this._linearBoost:1,o=(h,x,R)=>h<=x?x:h>=R?R:h,d=h=>10**(h/20);let r=this.maxDecibels,a=this.minDecibels;return i&&(r=d(r),a=d(a),e=d(e)**s),o((e-a)/(r-a)**s,0,1)}_setCanvas(e){if(!this._ready)return;const{canvas:i,_ctx:s}=this,o=this._scaleX.canvas,d=window.devicePixelRatio/(this._loRes+1);let r=window.screen.width*d,a=window.screen.height*d;Math.abs(window.orientation)==90&&r<a&&([r,a]=[a,r]);const h=this.isFullscreen,x=h&&this._fsEl==i,R=x?r:(this._width||this._container.clientWidth||this._defaultWidth)*d|0,u=x?a:(this._height||this._container.clientHeight||this._defaultHeight)*d|0;this._pixelRatio=d,this._fsWidth=r,this._fsHeight=a,!(i.width==R&&i.height==u)&&(i.width=R,i.height=u,this.overlay||(s.fillStyle="#000",s.fillRect(0,0,R,u)),s.lineJoin="bevel",o.width=R,o.height=Math.max(20*d,Math.min(R,u)/32|0),this._calcBars(),this._makeGrad(),this._fsStatus!==void 0&&this._fsStatus!==h&&(e=At),this._fsStatus=h,this.onCanvasResize&&this.onCanvasResize(e,this))}_setGradient(e,i){if(!this._gradients.hasOwnProperty(e))throw new he(Vt,e);[0,1].includes(i)||(this._selectedGrads[1]=e,i=0),this._selectedGrads[i]=e,this._makeGrad()}_setProps(e,i){const s={alphaBars:!1,ansiBands:!1,barSpace:.1,bgAlpha:.7,channelLayout:Le,colorMode:Xe,fftSize:8192,fillAlpha:1,frequencyScale:Fe,gradient:bt[0][0],ledBars:!1,linearAmplitude:!1,linearBoost:1,lineWidth:0,loRes:!1,lumiBars:!1,maxDecibels:-25,maxFPS:0,maxFreq:22e3,minDecibels:-85,minFreq:20,mirror:0,mode:0,noteLabels:!1,outlineBars:!1,overlay:!1,peakLine:!1,radial:!1,reflexAlpha:.15,reflexBright:1,reflexFit:!0,reflexRatio:0,roundBars:!1,showBgColor:!0,showFPS:!1,showPeaks:!0,showScaleX:!0,showScaleY:!1,smoothing:.5,spinSpeed:0,splitGradient:!1,start:!0,trueLeds:!1,useCanvas:!0,volume:1,weightingFilter:gt},o=["onCanvasDraw","onCanvasResize"],d=["gradientLeft","gradientRight","height","width","stereo"],r=Object.keys(s).filter(a=>a!="start").concat(o,d);(i||e===void 0)&&(e={...s,...e});for(const a of Object.keys(e))o.includes(a)&&typeof e[a]!="function"?this[a]=void 0:r.includes(a)&&(this[a]=e[a]);e.start!==void 0&&this.toggleAnalyzer(e.start)}}export{ti as A};
